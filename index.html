<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>UV debug</title>
  <style>body{background:#111;color:#eee;font-family:monospace}#log{white-space:pre-wrap}</style>
</head>
<body>
  <h3>Console log</h3>
  <div id="log"></div>
  <script>
    /* mirror every log to screen */
    const log = (...a) => {
      document.getElementById('log').textContent += a.join(' ') + '\n';
      console.log(...a);
    };
    window.addEventListener('error', e => log('ERROR', e.message, e.filename, e.lineno));
  </script>

  <script type="module">
    log('Registering SW...');
    try {
      const reg = await navigator.serviceWorker.register('/uv.sw.js?v=' + Date.now());
      log('SW registered', reg.scope);
      await navigator.serviceWorker.ready;
      log('SW ready');

      /* ---- UV ---- */
      const UV = await import('https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet@2/dist/ultraviolet.bundle.js');
      window.__uv$config = {
        prefix: '/service/',
        bare: '/bare/',                 // local stubs
        encodeUrl: UV.codec.xor.encode,
        decodeUrl: UV.codec.xor.decode,
        handler:  '/uv.handler.js',
        bundle:   '/uv.bundle.js',
        config:   '/uv.config.js',
        sw:       '/uv.sw.js'
      };
      const enc = '/service/' + __uv$config.encodeUrl('https://example.com');
      log('Loading:', enc);
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'width:100%;height:70vh;border:1px solid #555';
      iframe.src = enc;
      document.body.appendChild(iframe);
    } catch (e) {
      log('FAIL', e);
    }
  </script>
</body>
</html>
